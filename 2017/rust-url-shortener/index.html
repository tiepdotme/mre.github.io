

<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      html,body,div,form,fieldset,legend,label,h1,h2{margin:0;padding:0}body{font-family:"Book Antiqua","Palatino Linotype",Palatino,"EB Garamond",serif;font-size:1.2em;line-height:1.58;color:#111;border-top:0.5em solid #c35}.container{display:grid;grid-template-columns:auto;margin:0 auto}header{font-size:0.8em;text-align:center;padding-top:30px}.bio{width:210px;margin:auto;padding:16px}main{padding:5px;margin-bottom:50px;max-width:650px}main article{margin-bottom:44px}main img,main video,iframe{max-width:100%;height:auto}.homepage h1{font-size:130%}h1,h2,h3,h4,h5,h6,th,td,caption{font-weight:400}h1{font-size:1.87em;margin-bottom:8px}h2{font-size:1.2em}main h2{margin-top:60px}h3{margin-top:0px;font-style:italic}header nav ul{display:inline-block;padding-left:0px;margin-top:0}header nav li{list-style:none;display:inline}.post-meta{font-style:italic;margin:0px;font-size:90%}.homepage .post-meta{font-size:80%}.btn{color:#111;background-color:#fafafa;display:inline-block;font-weight:500;border-radius:6px;border:1px solid rgba(27,31,35,0.15);text-decoration:none;box-shadow:0 1px 0 rgba(27,31,35,0.04),inset 0 1px 0 rgba(255,255,255,0.25);transition:background-color 0.2s cubic-bezier(0.3, 0, 0.5, 1);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;padding:5px 16px;white-space:nowrap}.btn-sm{padding:3px 12px;font-size:15px;line-height:20px}.btn-ico{margin-right:4px;vertical-align:text-bottom;transition:transform 0.15s cubic-bezier(0.2, 0, 0.13, 2);transform:scale(1);color:#ff1c76;fill:currentColor}.btn:hover .btn-ico{transform:scale(1.1)}pre,code{font-family:operator mono,sfmono-regular,Consolas,liberation mono,Menlo,Courier,monospace}pre{display:inline-grid;border-radius:6px;width:100%;padding:5px 0}code{font-size:0.8em;padding:2px}pre>code{overflow-x:auto;display:inline-block}:not(pre)>code{color:#111;background:#fafafa;border-radius:6px;box-shadow:0 1px 1px rgba(0,0,0,0.125)}blockquote{border-left:4px solid #9fd6fa;font-style:italic;margin:4px 10px;padding:0px 20px}::selection{background:black;color:white}a{color:#111;text-decoration:underline;text-decoration-color:#c35;text-decoration-thickness:2px;transition:text-decoration-color 200ms}a:hover{text-decoration-color:#111}.icon{height:24px;width:24px;opacity:0.4;float:left;margin:5px;background-repeat:no-repeat}.icon:hover{opacity:1;transition:opacity 200ms ease-in}figure{font-size:0.9em;font-style:italic;margin:40px 0 40px;padding:0;text-align:center;text-indent:0}figcaption{margin-top:10px}.post-links{list-style:none;padding:0}.comments{list-style:none;display:inline}#teaser{background:#c35;color:#f5b2c8}#teaser a,footer a{color:white}#teaser a::after{content:"\a0¬ª"}footer{background:#234;color:#b9b9b9}#teaser,footer{display:flex;justify-content:center}#teaser .body,footer .body{max-width:800px;margin:40px auto;padding:20px}.field{padding:10px;font-size:0.8em;border:none;border:1px solid #b9b9b9}.autocomplete{position:relative;display:inline-block}.autocomplete input{border:1px solid #ddd;padding:10px 20px;border-radius:20px;width:150px;font-size:0.9em;box-shadow:0 1px 0px rgba(255,255,255,0.25)}input[type="submit"]{cursor:pointer;background-color:#b9b9b9}input:focus::placeholder{color:transparent}.autocomplete-items{position:absolute;left:0;top:38px;font-size:0.9em;line-height:1.5;width:100%}.autocomplete-items div{padding:10px;cursor:pointer;background-color:white;border:1px solid #ddd}.autocomplete-items div:hover,.autocomplete-active{background-color:#c35 !important;color:white}@media screen and (min-width: 600px){.container{justify-content:center;margin-top:40px;grid-template-columns:auto auto}header{position:sticky;top:0;height:100vh;box-sizing:border-box}main{padding:0px 30px;margin-top:20px}pre{padding:10px}.bio span:after{content:"Writes about Rust, engineering culture, and socks."}}@media not screen and (max-width: 800px){.searchicon{display:none}}@media screen and (max-width: 800px){#searchbox{display:none}#searchbox:target{display:block}.autocomplete{width:100%;font-size:1.1em}.autocomplete input{width:calc(100% - 100px);margin:20px 10px}.autocomplete-items{top:58px}}.info{padding:20px;margin:30px 0;background-color:lightyellow;border:4px solid peachpuff;position:relative;border-radius:6px}.logo_font{position:relative;width:165px;height:34px;margin:0 auto}.logo_font svg{position:absolute;top:0;left:0}@media (prefers-color-scheme: light){.logo_font_dark{display:none}}@media (prefers-color-scheme: dark){.logo_font_light{display:none}}@media (prefers-color-scheme: dark){body{background:#234;color:white;border-top:0.5em solid #ff1c76}.bio,.post-meta{color:#b9b9b9}a{color:white;text-decoration-color:#ff1c76}a:hover{text-decoration-color:white}.icon{filter:brightness(0) invert(1)}main img{background-color:white;border-radius:6px}table{width:100%}table a{border:none}th,td{border-bottom:1px solid #ddd}pre,code{-webkit-filter:invert(100%);filter:invert(100%)}.info{background:#141f2b;border-color:#555}.btn{background:#111;color:white}.autocomplete input,.autocomplete-items div{border:0;background:#141f2b;color:white}footer{background:#141f2b}}

    </style>
<title>Launching a URL Shortener in Rust using Rocket | Matthias Endler</title>
<link rel="canonical" href="https://endler.dev/2017/rust-url-shortener/">

<meta property="og:title" content="Launching a URL Shortener in Rust using Rocket | Matthias Endler" />
<meta property="og:type" content="website" />
<meta property="og:description" content="One common systems design task in interviews is to sketch the software architecture of a URL shortener (a bit.ly clone, if you may).
Since I was playing around with Rocket ‚Äì a web framework for Rust ‚Äì why not give it a try?
" />
<meta property="og:url" content="https://endler.dev/2017/rust-url-shortener/" />
<meta property="og:image" content="https://endler.dev/default.png" />

<meta name="twitter:title" content="Launching a URL Shortener in Rust using Rocket">
<meta name="twitter:description" content="One common systems design task in interviews is to sketch the software architecture of a URL shortener (a bit.ly clone, if you may).
Since I was playing around with Rocket ‚Äì a web framework for Rust ‚Äì why not give it a try?
">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@matthiasendler">
<meta name="twitter:creator" content="@matthiasendler">
<meta name="twitter:image" content="https://endler.dev/default.png">
    <link rel="canonical" href="https://endler.dev/2017/rust-url-shortener/" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-touch-icon.png?v=m2llJQPQq8"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon-32x32.png?v=m2llJQPQq8"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon-16x16.png?v=m2llJQPQq8"
    />
    <link
      rel="mask-icon"
      href="/safari-pinned-tab.svg?v=m2llJQPQq8"
      color="#5bbad5"
    />
    <link rel="shortcut icon" href="/favicon.ico?v=m2llJQPQq8" />
    <link href="/rss.xml" rel="alternate" type="application/rss+xml" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="author" content="Matthias Endler" />
    <meta
      name="description"
      content="Personal website of Matthias Endler, a Software Engineer interested in low-level programming and Backend development. Rust, Go"
    />
  </head>

  <body>
    <div class="container">
      <header>
        



<a href="/" aria-label="Go back to homepage">
  
  
  <div class="logo" style="width: 110px; margin: auto;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 456 456"><defs/><g letter-spacing="0" transform="translate(-167)" word-spacing="0"><circle cx="395" cy="228" r="220" fill="#fff" stroke="#000" stroke-width="16"/><path fill="#856800" fill-rule="evenodd" d="M468 266l-70 37-77-37z"/><path fill="#ffcb15" fill-rule="evenodd" d="M468 266l-70 31-77-31z"/><path d="M360 208a22 21 85 00-2 0 22 21 85 00-19 24 22 21 85 0023 19 22 21 85 0019-23 22 21 85 00-7-14 5 6 0 012 4 5 6 0 01-6 7 5 6 0 01-5-7 5 6 0 016-6 5 6 0 013 1 22 21 85 00-14-5zm71 1a22 21 85 00-2 0 22 21 85 00-19 23 22 21 85 0022 20 22 21 85 0019-24 22 21 85 00-20-19zm10 4a5 6 0 015 6 5 6 0 01-5 6 5 6 0 01-5-6 5 6 0 015-6z"/></g><path fill-rule="evenodd" d="M262 58c-4 9-12 19-19 24 1-8 2-16 1-22-4 8-12 18-20 24 2-7 2-15 1-21-7 13-15 24-29 28-70 20-131 113-152 213 11 28 29 53 51 73 8-158 45-267 112-208 10 9 16 13 20 13 5 0 10-4 21-13 67-59 105 50 112 208 22-20 40-45 51-73-20-95-77-184-144-209l-10-4c4-8 7-23 5-33z"/></svg>
  </div>
  <div class="logo_font">
    <div class="logo_font_dark">
    <?xml version="1.0" encoding="UTF-8"?>
<svg class="logo_font_dark" version="1.1" viewBox="0 0 786 139" xmlns="http://www.w3.org/2000/svg"><g fill="#fff"><path d="m69.2 12.8v112h48.6v-12.2h-36v-31.8h29.8v-12.2h-29.8v-43.2h36v-12.2z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m213 12.8h-12.6v112h12.6c31 0 56.3-24.6 56.3-55.7 0-31.2-25.3-55.8-56.3-55.8zm0 12.2c24.2 0 43.7 19.5 43.7 43.7 0 24-19.5 43.5-43.7 43.5z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m279 12.8v112h48.6v-12.2h-36v-99.4z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m398 12.8v112h12.6v-28c4.96 0 10.1 0.16 15-0.64l19.2 28.6h14.9l-22.7-32.3c13.8-6.56 22.7-20.2 22.7-37.4 0-24.3-18.1-41.8-42.2-41.8zm12.6 71.4v-59.2h6.88c13.9 0 29.6 9.28 29.6 29.6 0 20.3-15.4 29.6-29.6 29.6z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m338 12.8v112h48.6v-12.2h-36v-31.8h29.8v-12.2h-29.8v-43.2h36v-12.2z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m191 13.4h-11.7v73.3l-48.5-73v113h11.8v-71.6l48.4 71.7z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><g fill="#9f9f9f"><path d="m481 106c-4.79 0-8.7 3.9-8.7 8.7 0 4.79 3.9 8.7 8.7 8.7s8.7-3.9 8.7-8.7-3.9-8.7-8.7-8.7z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m502 12.7v110h14c30.9 0 55.7-24.3 55.7-55.2 0-30.7-24.8-55-55.7-55zm14 96.7v-83.2c23.1 0 41.7 18.6 41.7 41.5 0 23.1-18.6 41.7-41.7 41.7z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m643 12.7 37.1 111 37.1-111h-14.2l-22.9 69.4-23.1-69.4z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m583 13.1v111h48.4v-12.1h-35.8v-31.7h29.6v-12.1h-29.6v-43h35.8v-12.1z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g></svg>

    </div>
    <div class="logo_font_light">
    <?xml version="1.0" encoding="UTF-8"?>
<svg class="logo_font_light" version="1.1" viewBox="0 0 786.1 139.2" xmlns="http://www.w3.org/2000/svg"><g><path d="m69.212 12.818v111.53h48.644v-12.161h-36.003v-31.843h29.762v-12.161h-29.762v-43.203h36.003v-12.161z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m212.8 12.818h-12.641v111.53h12.641c31.042 0 56.324-24.642 56.324-55.684 0-31.203-25.282-55.845-56.324-55.845zm0 12.161c24.162 0 43.684 19.522 43.684 43.683 0 24.002-19.522 43.523-43.684 43.523z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m278.6 12.818v111.53h48.644v-12.161h-36.003v-99.368z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m397.99 12.818v111.53h12.641v-28.002c4.9603 0 10.081 0.15998 15.041-0.64l19.201 28.642h14.881l-22.722-32.323c13.761-6.5605 22.722-20.162 22.722-37.443 0-24.322-18.081-41.763-42.243-41.763zm12.641 71.366v-59.205h6.8805c13.921 0 29.602 9.2807 29.602 29.602 0 20.322-15.361 29.602-29.602 29.602z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m338.3 12.818v111.53h48.644v-12.161h-36.003v-31.843h29.762v-12.161h-29.762v-43.203h36.003v-12.161z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m190.51 13.387h-11.663v73.276l-48.474-72.993v112.67h11.784v-71.581l48.352 71.722z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g><g fill="#9f9f9f"><path d="m480.93 105.53c-4.7912 0-8.6953 3.904-8.6953 8.6953 0 4.7912 3.904 8.6953 8.6953 8.6953 4.7913 0 8.6953-3.904 8.6953-8.6953 0-4.7913-3.904-8.6953-8.6953-8.6953z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m502.04 12.723v110.2h14.019c30.877 0 55.721-24.311 55.721-55.189 0-30.7-24.844-55.011-55.721-55.011zm14.019 96.713v-83.226c23.069 0 41.702 18.633 41.702 41.524 0 23.069-18.633 41.702-41.702 41.702z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m642.71 12.723 37.088 110.73 37.088-110.73h-14.196l-22.892 69.385-23.069-69.385z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/><path d="m582.92 13.066v110.99h48.407v-12.102h-35.828v-31.688h29.618v-12.102h-29.618v-42.993h35.828v-12.102z" style="font-variant-caps:normal;font-variant-east-asian:normal;font-variant-ligatures:normal;font-variant-numeric:normal"/></g></svg>

    </div>
  </div>
</a>

        <p class="bio">
          <span>
            Open-source maintainer, speaker, rebel.
          </span>
          <a href="/about">About me.</a>
        </p>
        





<nav>
    <ul>
        <li>
            <a class="icon" href="/" title="Go to homepage" aria-label="Go to homepage">
                <svg xmlns='http://www.w3.org/2000/svg' version='1' viewBox='0 0 61 58'><path stroke='#fff' stroke-linecap='square' stroke-width='.52916' d='M7 21v36h16V38h15v19h15V21z'/><path d='M61 26H0l15-13L30 0l15 13z'/></svg>
            </a>
        </li>
        <li>
            <a class="icon" href="https://github.com/mre" title="Github" aria-label="Github">
                <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 578.3 578.3'><path d='M533 160c1-26-5-53-10-79-1-9-5-18-8-27-2-6-10-10-16-9l-12 3c-39 13-76 32-111 54-5 3-11 4-17 3l-41-5c-33-1-67 0-100 6-5 1-11 0-15-3-38-24-77-46-122-57-7-2-14-1-15 1l-3 6c-5 16-10 33-13 51-4 20-7 42-5 62 1 13-3 21-10 30-24 31-34 66-35 104-1 33 4 65 14 97 15 48 45 84 90 108 36 19 76 27 117 28h111c37 1 73-3 109-14 35-12 66-30 90-60 34-42 45-92 47-145 2-40-6-78-30-111a65 65 0 01-15-43zm-71 310c-16 13-35 20-55 25-39 9-79 11-119 10-39 1-78-1-116-10-28-7-54-18-72-42-29-39-36-112 11-152 12-11 26-17 41-18l53-3 133 3c20 0 40-5 60-4 18 2 38 5 54 12 28 12 42 37 47 66 7 43-2 83-37 113z'/><ellipse cx='390' cy='385.6' rx='42.1' ry='56.3'/><ellipse cx='189' cy='385.6' rx='42.1' ry='56.3'/></svg>
            </a>
        </li>
        <li>
            <a class="icon" href="https://twitter.com/matthiasendler" title="Twitter"
                aria-label="Twitter">
                <svg xmlns='http://www.w3.org/2000/svg' version='1' viewBox='0 0 612 612'><path fill='#010002' d='M612 116c-23 10-47 17-72 20 26-15 46-40 55-69-24 14-51 24-80 30a125 125 0 0 0-217 86c0 10 1 19 3 29-104-6-196-56-258-132a125 125 0 0 0 39 168c-21-1-40-6-57-16v2c0 61 43 111 100 123a127 127 0 0 1-56 2c16 50 62 86 117 87A252 252 0 0 1 0 498a355 355 0 0 0 550-301l-1-16c25-17 46-40 63-65z'/></svg> 
            </a>
        </li>
        <li>
            <a class="icon" href="/rss.xml" title="RSS feed"
                aria-label="RSS feed"><svg xmlns='http://www.w3.org/2000/svg' version='1' viewBox='0 0 1280 1280'><path d='M264 224l-1 79v79h8a660 660 0 0 1 438 174 665 665 0 0 1 218 492h156l1-26a820 820 0 0 0-715-792c-37-5-103-9-105-6z'/><path d='M263 504l-1 78 1 79 14 2a383 383 0 0 1 369 368l1 17h158v-19a536 536 0 0 0-98-293 546 546 0 0 0-444-232zM353 830a110 110 0 0 0-77 160 110 110 0 1 0 188-114c-5-7-23-25-30-29-25-16-54-22-81-17z'/></svg></a>
        </li>
        <li>
            <a class="searchicon icon" href="#searchbox" title="Search"
                aria-label="Search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90.1 90.1"><defs/><path d="M71.8 62.6a39.6 39.6 0 10-9.2 9.2L79 88.2a6.5 6.5 0 009.2-9.2zM13 39.6a26.5 26.5 0 1126.5 26.5 26.5 26.5 0 01-26.5-26.5z"/></svg>
            </a>
        </li>
    </ul>
</nav> 
<script type="module">async function lazyLoad(){await init("/tinysearch_engine_bg.wasm")}var loaded=!1;function autocomplete(e){var t;function n(e){if(!e)return!1;!function(e){for(var t=0;t<e.length;t++)e[t].classList.remove("autocomplete-active")}(e),t>=e.length&&(t=0),t<0&&(t=e.length-1),e[t].classList.add("autocomplete-active")}function a(t){for(var n=document.getElementsByClassName("autocomplete-items"),a=0;a<n.length;a++)t!=n[a]&&t!=e&&n[a].parentNode.removeChild(n[a])}e.addEventListener("click",(function(e){loaded||(lazyLoad(),loaded=!0)})),e.addEventListener("input",(function(e){var n,o,i,c=this.value;if(a(),!c)return!1;t=-1,(n=document.createElement("DIV")).setAttribute("id",this.id+"autocomplete-list"),n.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(n);let r=search(c,3);for(i=0;i<r.length;i++){let e=r[i];(o=document.createElement("DIV")).innerHTML=e[0],o.addEventListener("click",(function(t){window.location.href=`${e[1]}?q=${encodeURIComponent(c)}`})),n.appendChild(o)}})),e.addEventListener("keydown",(function(e){var a=document.getElementById(this.id+"autocomplete-list");a&&(a=a.getElementsByTagName("div")),40==e.keyCode?(t++,n(a)):38==e.keyCode?(t--,n(a)):13==e.keyCode&&(e.preventDefault(),t>-1&&a&&a[t].click())})),document.addEventListener("click",(function(e){a(e.target)}))}let wasm;autocomplete(document.getElementById("tinysearch"));let WASM_VECTOR_LEN=0,cachedTextEncoder=new TextEncoder("utf-8");const encodeString="function"==typeof cachedTextEncoder.encodeInto?function(e,t){return cachedTextEncoder.encodeInto(e,t)}:function(e,t){const n=cachedTextEncoder.encode(e);return t.set(n),{read:e.length,written:n.length}};let cachegetUint8Memory=null;function getUint8Memory(){return null!==cachegetUint8Memory&&cachegetUint8Memory.buffer===wasm.memory.buffer||(cachegetUint8Memory=new Uint8Array(wasm.memory.buffer)),cachegetUint8Memory}function passStringToWasm(e){let t=e.length,n=wasm.__wbindgen_malloc(t);const a=getUint8Memory();let o=0;for(;o<t;o++){const t=e.charCodeAt(o);if(t>127)break;a[n+o]=t}if(o!==t){0!==o&&(e=e.slice(o)),n=wasm.__wbindgen_realloc(n,t,t=o+3*e.length);const a=getUint8Memory().subarray(n+o,n+t);o+=encodeString(e,a).written}return WASM_VECTOR_LEN=o,n}const heap=new Array(32);function getObject(e){return heap[e]}heap.fill(void 0),heap.push(void 0,null,!0,!1);let heap_next=heap.length;function dropObject(e){e<36||(heap[e]=heap_next,heap_next=e)}function takeObject(e){const t=getObject(e);return dropObject(e),t}export function search(e,t){return takeObject(wasm.search(passStringToWasm(e),WASM_VECTOR_LEN,t))}let cachedTextDecoder=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});function getStringFromWasm(e,t){return cachedTextDecoder.decode(getUint8Memory().subarray(e,e+t))}function addHeapObject(e){heap_next===heap.length&&heap.push(heap.length+1);const t=heap_next;return heap_next=heap[t],heap[t]=e,t}function init(e){let t;void 0===e&&(e=import.meta.url.replace(/\.js$/,"_bg.wasm"));const n={wbg:{}};if(n.wbg.__wbindgen_json_parse=function(e,t){return addHeapObject(JSON.parse(getStringFromWasm(e,t)))},"function"==typeof URL&&e instanceof URL||"string"==typeof e||"function"==typeof Request&&e instanceof Request){const a=fetch(e);t="function"==typeof WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(a,n).catch(e=>a.then(t=>{if("application/wasm"!=t.headers.get("Content-Type"))return console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e),t.arrayBuffer();throw e}).then(e=>WebAssembly.instantiate(e,n))):a.then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,n))}else t=WebAssembly.instantiate(e,n).then(t=>t instanceof WebAssembly.Instance?{instance:t,module:e}:t);return t.then(({instance:e,module:t})=>(wasm=e.exports,init.__wbindgen_wasm_module=t,wasm))}export default init;</script>
<form id="searchbox" autocomplete="off">
    <div class="autocomplete">
        <input id="tinysearch" type="text" aria-label="Search through articles" placeholder="&#x1F50D; Search">
    </div>
</form>
      </header>

      <main>
        
<article>
  <p class='post-meta'>Published on 





9th of April, 2017

. Updated on 





26th of August, 2020


  </p>
  <h1>Launching a URL Shortener in Rust using Rocket</h1>
  
  <p>One common systems design task in interviews is to sketch the software architecture of a URL shortener (a <a href="https://bitly.com/">bit.ly</a> clone, if you may).
Since I was playing around with <a href="https://rocket.rs/">Rocket</a> ‚Äì a web framework for Rust ‚Äì why not give it a try?</p>
<span id="continue-reading"></span><figure>
        <img src=".&#x2F;rocket.svg" 
        loading="lazy"
            alt="A rocket travelling through space"
        />
    <figcaption>
        A rocket travelling through space
    </figcaption>
</figure>
<h2 id="requirements">Requirements</h2>
<p>A URL shortener has two main responsibilities:</p>
<ul>
<li>Create a short URL for a longer one (d'oh!).</li>
<li>Redirect to the longer link when the short link is requested.</li>
</ul>
<p>Let's call our service <code>rust.ly</code> (<em>Hint, hint:</em> the domain is still available at the time of writing...).</p>
<p>First, let's create a new Rust project:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">cargo new </span><span style="color:#ed9366;">--</span><span style="color:#61676c;">bin rustly
</span></code></pre>
<p>Next, we add Rocket to our <code>Cargo.toml</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">[dependencies]
rocket </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;0.2.4&quot;</span><span style="color:#61676c;">
rocket_codegen </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;0.2.4&quot;
</span></code></pre>
<p>Warning: Most likely you need to get the very newest Rocket version.
Otherwise, you might get some... entertaining error messages. Find the newest
version on <a href="https://crates.io/crates/rocket">crates.io</a>.</p>
<p>Since Rocket requires cutting-edge Rust features, we need to use a recent nightly
build. <a href="https://rustup.rs/">Rustup</a> provides a simple way to switch between stable and nightly.</p>
<div class="info">
  ü§î Nightly Rust might no longer be required. Has anyone tried without and can
report back?
</div>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">rustup update </span><span style="color:#ed9366;">&amp;&amp;</span><span style="color:#61676c;"> rustup </span><span style="color:#f51818;">override</span><span style="color:#61676c;"> set nightly
</span></code></pre><h2 id="a-first-prototype">A first prototype</h2>
<p>Now we can start coding our little service.
First, let's write a simple &quot;hello world&quot; skeleton to get started.
Put this into <code>src/main.rs</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676ccc;">#!</span><span style="color:#61676c;">[</span><span style="color:#f29718;">feature</span><span style="color:#61676c;">(plugin)]
</span><span style="color:#61676ccc;">#!</span><span style="color:#61676c;">[</span><span style="color:#f29718;">plugin</span><span style="color:#61676c;">(rocket_codegen)]

</span><span style="color:#fa6e32;">extern crate</span><span style="color:#61676c;"> rocket</span><span style="color:#61676ccc;">;

#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">get</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&lt;id&gt;&quot;</span><span style="color:#61676c;">)]
</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">lookup</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">id</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String {
    </span><span style="color:#f07171;">format!</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;‚è© You requested </span><span style="color:#ff8f40;">{}</span><span style="color:#86b300;">. Wonderful!&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> id)
}

</span><span style="color:#61676ccc;">#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">get</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&lt;url&gt;&quot;</span><span style="color:#61676c;">)]
</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">shorten</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">url</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String {
    </span><span style="color:#f07171;">format!</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;üíæ You shortened </span><span style="color:#ff8f40;">{}</span><span style="color:#86b300;">. Magnificent!&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> url)
}

</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">main</span><span style="color:#61676c;">() {
    rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">ignite()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">mount</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f07171;">routes!</span><span style="color:#61676c;">[lookup])
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">mount</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/shorten&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f07171;">routes!</span><span style="color:#61676c;">[shorten])
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">launch</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}
</span></code></pre>
<p>Under the hood, Rocket is doing some magic to enable this nice syntax.
More specifically, we use the <code>rocket_codegen</code> crate for that.</p>
<p>In order to bring the rocket library into scope, we write <code>extern crate rocket;</code>.</p>
<p>We defined the two <em>routes</em> for our service. Both routes will respond to a <code>GET</code> request.<br />
This is done by adding an <em>attribute</em> named <code>get</code> to a function.
The attribute can take additional arguments.
In our case, we define an <code>id</code> variable for the <code>lookup</code> endpoint and a <code>url</code> variable for the <code>shorten</code> endpoint.
Both variables are Unicode string slices. Since Rust has awesome Unicode support, we respond with a nice emoji just to show off. üï∂</p>
<p>Lastly, we need a <code>main</code> function, which launches Rocket and <em>mounts</em> our two routes. This way, they become publicly available.
If you want to know even more about the in-depth details, I may refer you to the <a href="https://rocket.rs/guide/">official Rocket documentation</a>.</p>
<p>Let's check if we're on the right track by running the application.</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">cargo run
</span></code></pre>
<p>After some compiling, you should get some lovely startup output from Rocket:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">üîß  Configured </span><span style="color:#fa6e32;">for</span><span style="color:#61676c;"> development</span><span style="color:#ed9366;">.
    =&gt;</span><span style="color:#61676c;"> address</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> localhost
    </span><span style="color:#ed9366;">=&gt;</span><span style="color:#61676c;"> port</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">8000
    </span><span style="color:#ed9366;">=&gt;</span><span style="color:#61676c;"> log</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> normal
    </span><span style="color:#ed9366;">=&gt;</span><span style="color:#61676c;"> workers</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">8</span><span style="color:#61676c;">
üõ∞  Mounting </span><span style="color:#86b300;">&#39;/&#39;</span><span style="color:#61676ccc;">:
    </span><span style="color:#ed9366;">=&gt; </span><span style="color:#ff8f40;">GET </span><span style="color:#ed9366;">/&lt;</span><span style="color:#61676c;">hash</span><span style="color:#ed9366;">&gt;</span><span style="color:#61676c;">
üõ∞  Mounting </span><span style="color:#ed9366;">&#39;/</span><span style="color:#61676c;">shorten</span><span style="color:#ed9366;">&#39;</span><span style="color:#61676ccc;">:
    </span><span style="color:#ed9366;">=&gt; </span><span style="color:#ff8f40;">GET </span><span style="color:#ed9366;">/</span><span style="color:#61676c;">shorten</span><span style="color:#ed9366;">/&lt;</span><span style="color:#61676c;">url</span><span style="color:#ed9366;">&gt;</span><span style="color:#61676c;">
üöÄ  Rocket has launched from https</span><span style="color:#61676ccc;">:</span><span style="font-style:italic;color:#abb0b6;">//localhost:8000...
</span></code></pre>
<p>Sweet! Let's call our service.</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">&gt; curl localhost:8000/shorten/www.endler.dev
üíæ You shortened www.endler.dev. Magnificent!

&gt; curl localhost:8000/www.endler.dev
‚è© You requested www.endler.dev. Wonderful!
</span></code></pre>
<p>So far so good.</p>
<h2 id="data-storage-and-lookup">Data storage and lookup</h2>
<p>We need to keep the shortened URLs over many requests... but how?
In a production scenario, we could use some NoSQL data store like <a href="https://redis.io/">Redis</a> for that.
Since the goal is to play with Rocket and learn some Rust, we will simply use an
in-memory store.</p>
<p>Rocket has a that feature called <a href="https://rocket.rs/v0.4/guide/state/">managed state</a>.
In our case, we want to manage a <em>repository</em> of URLs.</p>
<p>First, let's create a file named <code>src/repository.rs</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#fa6e32;">use </span><span style="color:#61676c;">std</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">collections</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">HashMap</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">shortener</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">Shortener</span><span style="color:#61676ccc;">;

</span><span style="color:#fa6e32;">pub struct </span><span style="color:#399ee6;">Repository </span><span style="color:#61676c;">{
    urls</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">HashMap&lt;</span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">, </span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">&gt;,
    shortener</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> Shortener,
}

</span><span style="color:#fa6e32;">impl </span><span style="color:#399ee6;">Repository </span><span style="color:#61676c;">{
    </span><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">new</span><span style="color:#61676c;">() </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> Repository {
        Repository {
            urls</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">HashMap</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new()</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;">
            shortener</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">Shortener</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new()</span><span style="color:#61676ccc;">,
        </span><span style="color:#61676c;">}
    }

    </span><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">store</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">mut </span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">, </span><span style="color:#ff8f40;">url</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String {
        </span><span style="color:#fa6e32;">let</span><span style="color:#61676c;"> id </span><span style="color:#ed9366;">= </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">shortener</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">next_id</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
        </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">urls</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">insert</span><span style="color:#61676c;">(id</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">to_string</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> url</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">to_string</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;</span><span style="color:#61676c;">
        id
    }

    </span><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">lookup</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">, </span><span style="color:#ff8f40;">id</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt; </span><span style="font-style:italic;color:#55b4d4;">Option</span><span style="color:#61676c;">&lt;</span><span style="color:#ed9366;">&amp;</span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">&gt; {
        </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">urls</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">get</span><span style="color:#61676c;">(id)
    }
}
</span></code></pre>
<p>Within this module we first import the <code>HashMap</code> implementation from the standard library.
We also include <code>shortener::Shortener;</code>, which helps us shorten the URLs in the next step. Don't worry too much about that for now.
By convention, we implement a <code>new()</code> method to create a <code>Repository</code> struct with an empty <code>HashMap</code> and a new <code>Shortener</code>. Additionally, we have two methods, <code>store</code> and <code>lookup</code>.</p>
<p><code>store</code> takes a URL and writes it to our in-memory HashMap storage. It uses our yet-to-be-defined shortener to create a unique id. It returns the shortened ID for the entry.
<code>lookup</code> gets a given ID from the storage, and returns it as an <code>Option</code>. If the ID is found, the return value will be <code>Some(url)</code>; if there is no match it will return <code>None</code>.</p>
<p>Note that we convert the string slices (<code>&amp;str</code>) to <code>String</code> using the <code>to_string()</code> method. This way we don't need to deal with <a href="https://doc.rust-lang.org/book/lifetimes.html">lifetimes</a>. As a beginner, don't think too hard about them.</p>
<h2 id="additional-remarks-can-safely-be-skipped">Additional remarks (can safely be skipped)</h2>
<p>A seasoned (Rust) developer‚Ñ¢ might do a few things differently here. Did you notice the tight coupling between the repository and the shortener? In a production system, <code>Repository</code> and <code>Shortener</code> might simply be concrete implementations of traits (which are a bit like interfaces in other languages, but more powerful). For example, <code>Repository</code> could implement a <code>Cache</code> trait:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#fa6e32;">trait </span><span style="color:#399ee6;">Cache </span><span style="color:#61676c;">{
    </span><span style="font-style:italic;color:#abb0b6;">// Store an entry and return an ID
    </span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">store</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">mut </span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">, </span><span style="color:#ff8f40;">data</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String</span><span style="color:#61676ccc;">;
    </span><span style="font-style:italic;color:#abb0b6;">// Look up a previously stored entry
    </span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">lookup</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">, </span><span style="color:#ff8f40;">id</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt; </span><span style="font-style:italic;color:#55b4d4;">Option</span><span style="color:#61676c;">&lt;</span><span style="color:#ed9366;">&amp;</span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">&gt;</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}
</span></code></pre>
<p>This way we get clear sepration of concerns, and we can easily switch to a different implementation (e.g. a <code>RedisCache</code>). Also, we could have a <code>MockRepository</code> to simplify testing. Same for <code>Shortener</code>.</p>
<p>On top of that, you might want to use the <code>Into</code> trait to support both, <code>&amp;str</code> and <code>String</code> as parameters of <code>store</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">store</span><span style="color:#61676c;">&lt;T</span><span style="color:#61676ccc;">: </span><span style="font-style:italic;color:#55b4d4;">Into</span><span style="color:#61676c;">&lt;</span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">&gt;&gt;(</span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">mut </span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">, </span><span style="color:#ff8f40;">url</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> T) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String {
		</span><span style="color:#fa6e32;">let</span><span style="color:#61676c;"> id </span><span style="color:#ed9366;">= </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">shortener</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">shorten</span><span style="color:#61676c;">(url)</span><span style="color:#61676ccc;">;
		</span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">urls</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">insert</span><span style="color:#61676c;">(id</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">to_owned</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> url</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">into</span><span style="color:#61676c;">())</span><span style="color:#61676ccc;">;</span><span style="color:#61676c;">
		id
}
</span></code></pre>
<p>If you're curious about this, read <a href="https://hermanradtke.com/2015/05/06/creating-a-rust-function-that-accepts-string-or-str.html">this article from Herman J. Radtke III</a>.
For now, let's keep it simple.</p>
<h2 id="actually-shortening-urls">Actually shortening URLs</h2>
<p>Let's implement the URL shortener itself.
You might be surprised how much was written about URL shortening <a href="https://blog.codinghorror.com/url-shortening-hashes-in-practice/">all over the web</a>.
One common way is to create <a href="https://stackoverflow.com/questions/742013/how-do-i-create-a-url-shortener">short URLs using base 62 conversion</a>.</p>
<p>After looking around some more, I found this sweet little crate called <a href="https://github.com/archer884/harsh">harsh</a>, which perfectly fits the bill. It creates a hash id from an input string.</p>
<p>To use <code>harsh</code>, we add it to the dependency section of our <code>Cargo.toml</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">harsh = &quot;0.1.2&quot;
</span></code></pre>
<p>Next, we add the crate to the top of to our <code>main.rs</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">extern crate harsh;
</span></code></pre>
<p>Let's create a new file named <code>src/shortener.rs</code> and write the following:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#fa6e32;">use </span><span style="color:#61676c;">harsh</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">{Harsh</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> HarshBuilder}</span><span style="color:#61676ccc;">;

</span><span style="color:#fa6e32;">pub struct </span><span style="color:#399ee6;">Shortener </span><span style="color:#61676c;">{
    id</span><span style="color:#61676ccc;">: </span><span style="color:#fa6e32;">u64</span><span style="color:#61676c;">,
    generator</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> Harsh,
}

</span><span style="color:#fa6e32;">impl </span><span style="color:#399ee6;">Shortener </span><span style="color:#61676c;">{
    </span><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">new</span><span style="color:#61676c;">() </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> Shortener {
        </span><span style="color:#fa6e32;">let</span><span style="color:#61676c;"> harsh </span><span style="color:#ed9366;">= </span><span style="color:#61676c;">HarshBuilder</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">init</span><span style="color:#61676c;">()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">unwrap</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;</span><span style="color:#61676c;">
        Shortener {
            id</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">0</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;">
            generator</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> harsh</span><span style="color:#61676ccc;">,
        </span><span style="color:#61676c;">}
    }

    </span><span style="color:#fa6e32;">pub fn </span><span style="color:#f29718;">next_id</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">mut </span><span style="color:#ff8f40;">self</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> String {
        </span><span style="color:#fa6e32;">let</span><span style="color:#61676c;"> hashed </span><span style="color:#ed9366;">= </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">generator</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">encode</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#61676c;">[</span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">id])</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">unwrap</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
        </span><span style="font-style:italic;color:#55b4d4;">self</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">id </span><span style="color:#ed9366;">+= </span><span style="color:#ff8f40;">1</span><span style="color:#61676ccc;">;</span><span style="color:#61676c;">
        hashed
    }
}
</span></code></pre>
<p>With <code>use harsh::{Harsh, HarshBuilder};</code> we bring the required structs into scope. Then we define our own <code>Shortener</code> struct, which wraps <code>Harsh</code>. It has two fields: <code>id</code> stores the next id for shortening. (Since there won't be any negative ids, we use an <a href="https://en.wikipedia.org/wiki/Integer_(computer_science)#Value_and_representation">unsigned integer</a> for that.) The other field is the <code>generator</code> itself, for which we use <code>Harsh</code>.
Using the <code>HarshBuilder</code> you can do a lot of fancy stuff, like setting a custom alphabet for the ids. We're good for now, but for more info, check out the <a href="https://github.com/archer884/harsh/">official docs</a>.
With <code>next_id</code> we retrieve a new <code>String</code> id for our URLs.</p>
<p>As you can see, we don't pass the URL to <code>next_id</code>. That means we actually <em>don't shorten anything</em>. We merely create a short, unique ID. That's because most hashing algorithms produce fairly <a href="https://blog.codinghorror.com/url-shortening-hashes-in-practice/">long URLs</a> and having short URLs is kind of the whole idea.</p>
<h2 id="wiring-it-up">Wiring it up</h2>
<p>So we are done with our shortener and the repository.
We need to adjust our <code>src/main.rs</code> again to make use of the two.</p>
<p>This is the point where it gets a little hairy.</p>
<p>I have to admit that I struggled a bit here.
Mainly because I was not used to multi-threaded request handling. In Python or
PHP you don't need to think about shared-mutable access.</p>
<p>Initially I had the following code in my <code>main.rs</code>:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676ccc;">#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">get</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&lt;url&gt;&quot;</span><span style="color:#61676c;">)]
</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">store</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">repo</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">State&lt;Repository&gt;, </span><span style="color:#ff8f40;">url</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) {
    repo</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">store</span><span style="color:#61676c;">(url)</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}

</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">main</span><span style="color:#61676c;">() {
    rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">ignite()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">manage</span><span style="color:#61676c;">(Repository</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new())
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">mount</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/store&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f07171;">routes!</span><span style="color:#61676c;">[store])
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">launch</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}
</span></code></pre>
<p><a href="https://rocket.rs/guide/state/">State</a> is the built-in way to save data across requests in Rocket. Just tell it what belongs to your application state with <code>manage()</code> and Rocket will automatically inject it into the routes.</p>
<p>But the compiler said no:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">error</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> cannot borrow immutable borrowed content </span><span style="color:#ed9366;">as</span><span style="color:#61676c;"> mutable
  </span><span style="color:#ed9366;">-</span><span style="color:#61676ccc;">-&gt;</span><span style="color:#61676c;"> src</span><span style="color:#ed9366;">/</span><span style="color:#61676c;">main</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">rs
   </span><span style="color:#ed9366;">|
   |</span><span style="color:#61676c;">     repo</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">store</span><span style="color:#61676c;">(url)</span><span style="color:#61676ccc;">;
   </span><span style="color:#61676c;">|     ^^^^ cannot borrow as mutable
</span></code></pre>
<p>In hindsight it all makes sense: What would happen if two requests wanted to modify our repository at the same time?
Rust prevented a race condition here! Yikes.
Admittedly, the error message could have been a bit more user-friendly, though.</p>
<p>Fortunately, <a href="https://github.com/SergioBenitez">Sergio Benitez</a> (the creator of Rocket) helped me out on the <a href="https://kiwiirc.com/client/irc.mozilla.org/#rocket">Rocket IRC channel</a> (thanks again!).
The solution was to put the repository behind a Mutex.</p>
<p>Here is our <code>src/main.rs</code> in its full glory:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676ccc;">#!</span><span style="color:#61676c;">[</span><span style="color:#f29718;">feature</span><span style="color:#61676c;">(plugin</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> custom_derive)]
</span><span style="color:#61676ccc;">#!</span><span style="color:#61676c;">[</span><span style="color:#f29718;">plugin</span><span style="color:#61676c;">(rocket_codegen)]

</span><span style="color:#fa6e32;">extern crate</span><span style="color:#61676c;"> rocket</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">extern crate</span><span style="color:#61676c;"> harsh</span><span style="color:#61676ccc;">;

</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">std</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">sync</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">RwLock</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">State</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">request</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">Form</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">response</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">Redirect</span><span style="color:#61676ccc;">;

</span><span style="color:#fa6e32;">mod </span><span style="color:#399ee6;">repository</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">mod </span><span style="color:#399ee6;">shortener</span><span style="color:#61676ccc;">;
</span><span style="color:#fa6e32;">use </span><span style="color:#61676c;">repository</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">Repository</span><span style="color:#61676ccc;">;

#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">derive</span><span style="color:#61676c;">(FromForm)]
</span><span style="color:#fa6e32;">struct </span><span style="color:#399ee6;">Url </span><span style="color:#61676c;">{
    url</span><span style="color:#61676ccc;">:</span><span style="color:#61676c;"> String,
}

</span><span style="color:#61676ccc;">#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">get</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&lt;id&gt;&quot;</span><span style="color:#61676c;">)]
</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">lookup</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">repo</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">State&lt;RwLock&lt;Repository&gt;&gt;, </span><span style="color:#ff8f40;">id</span><span style="color:#61676ccc;">: </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">str</span><span style="color:#61676c;">) </span><span style="color:#61676ccc;">-&gt; </span><span style="font-style:italic;color:#55b4d4;">Result</span><span style="color:#61676c;">&lt;Redirect, </span><span style="color:#ed9366;">&amp;</span><span style="color:#fa6e32;">&#39;static str</span><span style="color:#61676c;">&gt; {
    </span><span style="color:#fa6e32;">match</span><span style="color:#61676c;"> repo</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">read</span><span style="color:#61676c;">()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">unwrap</span><span style="color:#61676c;">()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">lookup</span><span style="color:#61676c;">(id) {
        </span><span style="font-style:italic;color:#55b4d4;">Some</span><span style="color:#61676c;">(url) </span><span style="color:#ed9366;">=&gt; </span><span style="font-style:italic;color:#55b4d4;">Ok</span><span style="color:#61676c;">(Redirect</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">permanent(url))</span><span style="color:#61676ccc;">,
        </span><span style="color:#ed9366;">_ =&gt; </span><span style="font-style:italic;color:#55b4d4;">Err</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;Requested ID was not found.&quot;</span><span style="color:#61676c;">)
    }
}

</span><span style="color:#61676ccc;">#</span><span style="color:#61676c;">[</span><span style="color:#f29718;">post</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&quot;</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> data </span><span style="color:#ed9366;">= </span><span style="color:#86b300;">&quot;&lt;url_form&gt;&quot;</span><span style="color:#61676c;">)]
</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">shorten</span><span style="color:#61676c;">(</span><span style="color:#ff8f40;">repo</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">State&lt;RwLock&lt;Repository&gt;&gt;, </span><span style="color:#ff8f40;">url_form</span><span style="color:#61676ccc;">: </span><span style="color:#61676c;">Form&lt;Url&gt;) </span><span style="color:#61676ccc;">-&gt; </span><span style="font-style:italic;color:#55b4d4;">Result</span><span style="color:#61676c;">&lt;</span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">, </span><span style="font-style:italic;color:#55b4d4;">String</span><span style="color:#61676c;">&gt; {
    </span><span style="color:#fa6e32;">let ref</span><span style="color:#61676c;"> url </span><span style="color:#ed9366;">=</span><span style="color:#61676c;"> url_form</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">get</span><span style="color:#61676c;">()</span><span style="color:#ed9366;">.</span><span style="color:#61676c;">url</span><span style="color:#61676ccc;">;
    </span><span style="color:#fa6e32;">let mut</span><span style="color:#61676c;"> repo </span><span style="color:#ed9366;">=</span><span style="color:#61676c;"> repo</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">write</span><span style="color:#61676c;">()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">unwrap</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
    </span><span style="color:#fa6e32;">let</span><span style="color:#61676c;"> id </span><span style="color:#ed9366;">=</span><span style="color:#61676c;"> repo</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">store</span><span style="color:#61676c;">(</span><span style="color:#ed9366;">&amp;</span><span style="color:#61676c;">url)</span><span style="color:#61676ccc;">;
    </span><span style="font-style:italic;color:#55b4d4;">Ok</span><span style="color:#61676c;">(id</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">to_string</span><span style="color:#61676c;">())
}

</span><span style="color:#fa6e32;">fn </span><span style="color:#f29718;">main</span><span style="color:#61676c;">() {
    rocket</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">ignite()</span><span style="color:#ed9366;">.</span><span style="color:#f07171;">manage</span><span style="color:#61676c;">(RwLock</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new(Repository</span><span style="color:#ed9366;">::</span><span style="color:#61676c;">new()))
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">mount</span><span style="color:#61676c;">(</span><span style="color:#86b300;">&quot;/&quot;</span><span style="color:#61676ccc;">, </span><span style="color:#f07171;">routes!</span><span style="color:#61676c;">[lookup</span><span style="color:#61676ccc;">,</span><span style="color:#61676c;"> shorten])
                    </span><span style="color:#ed9366;">.</span><span style="color:#f07171;">launch</span><span style="color:#61676c;">()</span><span style="color:#61676ccc;">;
</span><span style="color:#61676c;">}
</span></code></pre>
<p>As you can see we're using a <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html">std::sync::RwLock</a> here, to protect our repository from shared mutable access. This type of lock allows any number of readers or at most one writer at the same time.
It makes our code a bit harder to read because whenever we want to access our repository, we need to call the <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html#method.read">read</a> and <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html#method.write">write</a> methods first.</p>
<p>In our <code>lookup</code> method, you can see that we are returning a <a href="https://doc.rust-lang.org/std/result/enum.Result.html">Result</a> type now. It has two cases: if we find an id in our repository, we return <code>Ok(Redirect::permanent(url))</code>, which will take care of the redirect. If we can't find the id, we return an <code>Error</code>.</p>
<p>In our <code>shorten</code> method, we switched from a <code>get</code> to a <code>post</code> request.
The advantage is, that we don't need to deal with URL encoding. We just create a struct <code>Url</code> and derive <a href="https://rocket.rs/v0.4/guide/requests/">FromForm</a> for it, which will handle the deserialization for us. Fancy!</p>
<p>We're done. Let's fire up the service again and try it out!</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">cargo run
</span></code></pre>
<p>In a new window, we can now store our first URL:</p>
<pre style="background-color:#fafafa;">
<code><span style="color:#61676c;">curl --data &quot;url=https://www.endler.dev&quot; https://localhost:8000/
</span></code></pre>
<p>We get some ID back that we can use to retrieve the URL again. In my case, this was <code>gY</code>.
Point your browser to https://localhost:8000/gY and you should be redirected to my homepage.</p>
<h2 id="summary">Summary</h2>
<p>Rocket provides fantastic documentation and a great community.
It really feels like an idiomatic Rustlang web framework.</p>
<p>I hope you had some fun while playing with Rocket.<br />
You can <a href="https://github.com/mre/rustly">find the full example code on Github</a>.</p>


  <ul class='post-links'>
    
    <li>
      
üí¨ Comments on

<a href="https:&#x2F;&#x2F;www.reddit.com&#x2F;r&#x2F;programming&#x2F;comments&#x2F;64li3l&#x2F;launching_a_url_shortener_in_rust_using_rocket&#x2F;">Reddit</a>,

<a href="https:&#x2F;&#x2F;twitter.com&#x2F;matthiasendler&#x2F;status&#x2F;851128136624480256">Twitter</a>.


    </li>
    
    
  </ul>
  <div class="info">
  <p>
    Thanks for reading! If you would like to receive future posts automatically,
    you can subscribe via email or <a href="/rss.xml">RSS</a>.
  </p>
  <form
    action="https://tinyletter.com/mre"
    method="post"
    target="popupwindow"
    onsubmit="window.open('https://tinyletter.com/mre', 'popupwindow', 'scrollbars=yes,width=800,height=600'); return true"
  >
    <p>
      <input
        class="field"
        type="email"
        name="email"
        id="tlemail"
        placeholder="E-Mail address"
        aria-label="E-mail address"
      />
      <input type="hidden" value="1" name="embed" /><input
        class="field submit"
        type="submit"
        value="Subscribe"
      />
    </p>
  </form>
  <p>
    Want to read more stories?
    <a
      class="btn btn-sm"
      aria-label="Sponsor Matthias on Github"
      href="https://github.com/sponsors/mre/"
    >
      <svg
        class="btn-ico"
        viewBox="0 0 16 16"
        version="1.1"
        width="16"
        height="16"
        aria-hidden="true"
      >
        <path
          fill-rule="evenodd"
          d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5zM8 14.25l-.345.666-.002-.001-.006-.003-.018-.01a7.643 7.643 0 01-.31-.17 22.075 22.075 0 01-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.08 22.08 0 01-3.744 2.584l-.018.01-.006.003h-.002L8 14.25zm0 0l.345.666a.752.752 0 01-.69 0L8 14.25z"
        ></path></svg
      ><span>Sponsor</span></a
    >
  </p>
</div>

  

</article>

        </div>
      </main>
    </div>
    

<section id="teaser">
  <div class="body">
    <h2><a href="https:&#x2F;&#x2F;endler.dev&#x2F;2017&#x2F;the-essence-of-information&#x2F;">The Essence of Information</a></h2>
    <p>
      
        People look confused when I tell them about my passion for algorithms and data-structures.
Most of them understand what a Programmer is doing, but not what Computer Science is good for.
And even if they do, they think it has no practical relevance.
Let me show you with a simple example, that applied‚Ä¶
      
      <a href="https:&#x2F;&#x2F;endler.dev&#x2F;2017&#x2F;the-essence-of-information&#x2F;">Continue reading</a>
    </p>
  </div>
</section>


 <footer>
    <div class="body">
        <div>
            <h2><a href="/about">About me</a></h2>
            <p>
                I'm a Backend Engineer running <i><a href="https://hello-rust.show/">Hello, Rust!</a></i>, a YouTube
                channel about the Rust
                programming language and <a href="https://analysis-tools.dev/">analysis-tools.dev</a>, an open platform for static analysis tools.
                On this blog, you'll mostly find articles about programming in
                <a href="/2017/yes/">Rust</a> and <a href="/2018/go-io-testing/">Golang</a> or developer tools like <a
                    href="/2017/makefiles/">make</a> and <a href="/2018/ten-years-of-vim/">Vim</a>. 
                    Don't know where to start? Check out the <a href="/archive">blog archive</a>.
            </p>
        </div>
        <div>
            <h2><a href="https://github.com/sponsors/mre/">Support</a></h2>
            <p>
                Maintaining this blog and my projects is a lot of work. With
                your help I can spend more time writing and developing. The
                best way to support me is to <a
                href="https://github.com/sponsors/mre/">sponsor me on
                GitHub</a>.  GitHub will even match sponsorships until October
                2020!  Alternatively, I also have a <a
                href="https://www.patreon.com/hellorust">Patreon</a> account.
                Thank you! ‚ù§Ô∏è
            </p>
        </div>
    </div>
</footer>
  </body>
</html>
